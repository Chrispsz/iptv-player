<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPTV Player</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #fff;
            min-height: 100vh;
        }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .header {
            background: linear-gradient(135deg, #7c3aed 0%, #2563eb 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .header-title { font-size: 24px; font-weight: 700; }
        .card {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        textarea {
            width: 100%;
            min-height: 120px;
            padding: 16px;
            border: 2px solid #334155;
            border-radius: 10px;
            background: #0f172a;
            color: #fff;
            font-size: 14px;
            font-family: monospace;
        }
        textarea:focus { outline: none; border-color: #60a5fa; }
        .button {
            background: #3b82f6;
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 16px 24px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            margin-top: 12px;
        }
        .button:hover { background: #2563eb; }
        .button:disabled { opacity: 0.5; cursor: not-allowed; }
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
        }
        .category-btn {
            background: rgba(255,255,255,0.1);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 14px;
            font-size: 14px;
            cursor: pointer;
        }
        .category-btn:hover { background: #3b82f6; }
        .channel-list {
            max-height: 400px;
            overflow-y: auto;
            background: #1e293b;
            border-radius: 12px;
            padding: 12px;
        }
        .channel-item {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #0f172a;
            border: 1px solid rgba(255,255,255,0.2);
            cursor: pointer;
            font-size: 14px;
        }
        .channel-item:hover, .channel-item.selected {
            background: #3b82f6;
            border-color: #3b82f6;
        }
        .selected-channel {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
            margin-top: 16px;
            border: 2px solid #3b82f6;
        }
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }
        .player-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 16px;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        .player-btn:hover { background: rgba(255,255,255,0.2); }
        .player-btn.universal {
            background: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
        }
        .player-btn.universal:hover { background: rgba(34, 197, 94, 0.3); }
        .hidden { display: none !important; }
        .loading { text-align: center; padding: 20px; color: #3b82f6; }
        .spinner {
            border: 4px solid rgba(255,255,255,0.2);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .log-box {
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            padding: 12px;
            margin-top: 16px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 11px;
            flex: 1;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 12px 16px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .tab-btn:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
        }
        .tab-btn.active {
            background: #3b82f6;
            border-color: #3b82f6;
        }
        .channel-item-fav {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .favorite-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .favorite-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.4);
        }
        .favorite-btn.is-favorite {
            color: #fbbf24;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-title">üì∫ IPTV Player</div>
            <button onclick="window.location.href='/tv.html'" style="background: rgba(255,255,255,0.2); border: none; border-radius: 8px; padding: 8px 16px; color: white; cursor: pointer; font-size: 14px; font-weight: 600; margin-top: 12px;">
                üì∫ Parear TV
            </button>
        </div>

        <div class="card">
            <div style="margin-bottom: 12px; font-weight: 600;">Credenciais:</div>
            <textarea id="credentials-input" placeholder="Cole suas credenciais...

Exemplo:
Servidor: servidor.com:80
Usu√°rio: usuario
Senha: senha"></textarea>
            <div style="display: flex; gap: 8px; margin-top: 12px;">
                <button class="button" id="connect-btn" onclick="connect()">üîó Conectar</button>
                <button class="button" onclick="loadSavedCredentials()" style="background: rgba(255,255,255,0.1); flex: 1;">üíæ Salvas</button>
                <button class="button" onclick="clearCredentials()" style="background: rgba(239,68,68,0.2); flex: 1;">üóëÔ∏è Limpar</button>
            </div>
        </div>

        <div id="categories-section" class="card hidden">
            <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                <button onclick="showTab('categories')" id="tab-categories" class="tab-btn active">üìÇ Categorias</button>
                <button onclick="showTab('favorites')" id="tab-favorites" class="tab-btn">‚≠ê Favoritos</button>
            </div>
            <div id="categories-grid" class="categories-grid"></div>
        </div>

        <div id="favorites-section" class="card hidden">
            <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                <button onclick="showTab('categories')" id="tab-categories-fav" class="tab-btn">üìÇ Categorias</button>
                <button onclick="showTab('favorites')" id="tab-favorites-fav" class="tab-btn active">‚≠ê Favoritos</button>
            </div>
            <input type="text" id="search-favorites" placeholder="Buscar favorito..."
                   style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #334155;
                          background: #0f172a; color: #fff; margin-bottom: 12px;"
                   oninput="filterFavorites()">
            <div id="favorites-list" class="channel-list"></div>
            <div id="no-favorites" class="hidden" style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">
                <div style="font-size: 48px; margin-bottom: 16px;">‚≠ê</div>
                <p>Nenhum favorito ainda</p>
                <p style="font-size: 13px; margin-top: 8px;">Adicione canais aos favoritos clicando na ‚≠ê</p>
            </div>
        </div>

        <div id="channels-section" class="card hidden">
            <div style="margin-bottom: 12px; font-weight: 600;">
                Canais: <span id="channel-count">0</span>
            </div>
            <input type="text" id="search-input" placeholder="Buscar canal..."
                   style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #334155;
                          background: #0f172a; color: #fff; margin-bottom: 12px;"
                   oninput="filterChannels()">
            <div id="channel-list" class="channel-list"></div>
        </div>

        <div id="selected-channel" class="selected-channel hidden">
            <div style="font-size: 20px; font-weight: 700; margin-bottom: 12px;" id="channel-name">Canal Selecionado</div>
            <div style="font-size: 12px; word-break: break-all; background: #0f172a; padding: 10px;
                 border-radius: 8px; margin-bottom: 12px; color: #60a5fa;" id="stream-url"></div>

            <div style="font-weight: 600; margin-bottom: 12px;">Abrir no Player:</div>
            <div class="players-grid">
                <button class="player-btn universal" onclick="openUniversal()">
                    üöÄ Universal<br><small style="font-weight:400; opacity:0.7">Auto-detecta</small>
                </button>
                <button class="player-btn" onclick="openInVLC()">
                    üçä VLC<br><small style="font-weight:400; opacity:0.7">Android/iOS/Desktop</small>
                </button>
                <button class="player-btn" onclick="openInJustPlayer()">
                    üì± JustPlayer<br><small style="font-weight:400; opacity:0.7">Android TV</small>
                </button>
                <button class="player-btn" onclick="copyUrl()">
                    üìã Copiar URL<br><small style="font-weight:400; opacity:0.7">Cole no player</small>
                </button>
            </div>
        </div>

        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <div>Carregando...</div>
        </div>


    <script>
        let host = '', username = '', password = '';
        let categories = [], allChannels = [], filteredChannels = [];
        let selectedChannel = null;
        let autoConnect = false;

        const EXCLUDED_CATS = ['filme', 'movie', 'film', 'vod', 'series', 'series4k', '4kseries',
                               'radio', 'r√°dio', 'music', 'musica', 'audio', 'som', 'adult', 'xxx', 'porn'];
        const BRAZIL_KEYWORDS = ['brasil', 'brazil', 'brasileira', 'brasileiro', 'globo', 'record',
                               'sbt', 'band', 'rede', 'aberta', 'aberto', 's√£o paulo', 'rio', 'minas',
                               'bahia', 'paran√°', 'catarinense', 'ga√∫cha', 'bras√≠lia', 'df', 'sp',
                               'rj', 'mg', 'rs', 'pr', 'sc', 'ba', 'pe', 'go', 'es', 'ce', 'am', 'pa', 'rn'];

        function log(msg) {
            const logBox = document.getElementById('log-output');
            const time = new Date().toLocaleTimeString();
            logBox.innerHTML += `<div class="log-entry">[${time}] ${msg}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
        }

        function show(id) { document.getElementById(id).classList.remove('hidden'); }
        function hide(id) { document.getElementById(id).classList.add('hidden'); }

        // Carregar credenciais dos par√¢metros URL (do pareamento)
        function loadCredentialsFromURL() {
            const params = new URLSearchParams(window.location.search);
            const hostParam = params.get('host');
            const userParam = params.get('user');
            const passParam = params.get('pass');

            if (hostParam && userParam && passParam) {
                console.log('üì• Credenciais recebidas do pareamento');
                host = hostParam;
                username = userParam;
                password = passParam;

                // Preencher textarea
                const text = `Servidor: ${host}\nUsu√°rio: ${username}\nSenha: ${password}`;
                document.getElementById('credentials-input').value = text;

                // Salvar no localStorage
                saveCredentials();

                // Auto-connect
                autoConnect = true;
                console.log('üöÄ Auto-conectando...');
                setTimeout(() => connect(), 500);
            }
        }

        // Salvar credenciais no localStorage
        function saveCredentials() {
            const credentials = { host, username, password, savedAt: new Date().toISOString() };
            localStorage.setItem('iptv_saved_credentials', JSON.stringify(credentials));
            console.log('üíæ Credenciais salvas');
        }

        // Carregar credenciais salvas
        function loadSavedCredentials() {
            const saved = localStorage.getItem('iptv_all_credentials');
            if (saved) {
                try {
                    const credentialsList = JSON.parse(saved);

                    // Mostrar modal ou preencher com a primeira
                    if (credentialsList.length > 0) {
                        const credentials = credentialsList[0];
                        const text = `Servidor: ${credentials.host}\nUsu√°rio: ${credentials.username}\nSenha: ${credentials.password}`;
                        document.getElementById('credentials-input').value = text;

                        if (credentialsList.length > 1) {
                            log(`üíæ ${credentialsList.length} credenciais salvas. Mostrando a primeira.`);
                        } else {
                            log('üíæ Credencial salva carregada');
                        }
                    }
                } catch (e) {
                    console.error('‚ùå Erro ao carregar salvas:', e);
                    log('‚ùå Erro ao carregar credenciais salvas');
                }
            } else {
                log('‚ùå Nenhuma credencial salva encontrada');
            }
        }

        // Limpar credenciais
        function clearCredentials() {
            if (confirm('Deseja limpar as credenciais salvas?')) {
                localStorage.removeItem('iptv_saved_credentials');
                localStorage.removeItem('iptv_paired_credentials');
                document.getElementById('credentials-input').value = '';
                log('üóëÔ∏è Credenciais limpas');
            }
        }

        async function connect() {
            const text = document.getElementById('credentials-input').value;

            // Se n√£o tem texto e h√° credenciais salvas, tentar automaticamente
            if (!text.trim() && credentialsList.length > 0) {
                log('üîÑ Tentando credenciais salvas automaticamente...');
                const success = await tryAllCredentials();
                if (success) {
                    hide('loading');
                    show('categories-section');
                    renderCategories();
                }
                return;
            }

            // Parse credentials
            const lines = text.split('\n');
            lines.forEach(line => {
                const lower = line.toLowerCase().trim();
                if (lower.includes('servidor:') || lower.includes('*servidor:')) {
                    const match = line.match(/[:*]\s*([^:\s]+)/);
                    if (match) host = match[1].trim();
                }
                if (lower.includes('usu√°rio:') || lower.includes('usuario:') || lower.includes('*usu√°rio:') || lower.includes('*usuario:')) {
                    const match = line.match(/[:*]\s*([^\s]+)/);
                    if (match) username = match[1].trim();
                }
                if (lower.includes('senha:') || lower.includes('*senha:')) {
                    const match = line.match(/[:*]\s*([^\s]+)/);
                    if (match) password = match[1].trim();
                }
                if (lower.includes('m3u+:')) {
                    const urlMatch = line.match(/https?:\/\/([^\/]+)/);
                    if (urlMatch) host = urlMatch[1].trim();
                }
                if (lower.includes('get.php')) {
                    const urlMatch = line.match(/username=([^&]+)/);
                    if (urlMatch) username = urlMatch[1].trim();
                    const passMatch = line.match(/password=([^&]+)/);
                    if (passMatch) password = passMatch[1].trim();
                }
            });

            if (!host || !username || !password) {
                log('‚ùå Credenciais inv√°lidas');
                return;
            }

            // Salvar credenciais no localStorage (se n√£o for auto-connect)
            if (!autoConnect) {
                saveCredentials();
            }

            log('üîó Conectando...');
            hide('categories-section');
            hide('channels-section');
            hide('selected-channel');

            // Fix port
            if (!host.includes(':')) {
                host += ':80';
            }

            const cleanHost = host.split(':')[0];
            const port = host.split(':')[1] || '80';
            const baseUrl = `http://${cleanHost}:${port}`;

            // Load categories - usar get_live_categories para canais ao vivo
            show('loading');
            try {
                const catUrl = `${baseUrl}/player_api.php?username=${username}&password=${password}&action=get_live_categories`;
                log(`üìÇ Carregando categorias (ao vivo)...`);
                const response = await fetch(`/api/iptv/proxy-new?url=${encodeURIComponent(catUrl)}`);
                const responseData = await response.json();

                console.log('üìä Resposta da API:', responseData);

                // Verificar se √© array de categorias (resposta normal)
                if (Array.isArray(responseData)) {
                    if (responseData.length === 0) {
                        log('‚ö†Ô∏è Nenhuma categoria encontrada. Verifique suas credenciais.');
                        hide('loading');
                        return;
                    }

                    categories = responseData;

                    // Filter Brazilian
                    categories = categories.filter(cat => {
                        const name = cat.category_name.toLowerCase();
                        return BRAZIL_KEYWORDS.some(kw => name.includes(kw)) &&
                               !EXCLUDED_CATS.some(ex => name.includes(ex));
                    });

                    // Limit to top categories
                    categories = categories.slice(0, 50);

                    if (categories.length === 0) {
                        // Se n√£o achou brasileiras, mostra todas (pode n√£o ter filtro espec√≠fico)
                        categories = responseData.slice(0, 50);
                        log(`‚úÖ ${categories.length} categorias (todas)`);
                        renderCategories();
                        show('categories-section');

                        return;
                    }

                    log(`‚úÖ ${categories.length} categorias brasileiras`);
                    renderCategories();
                    show('categories-section');

                    return;
                }

                // Se n√£o √© array, verificar se √© resposta de autentica√ß√£o (user_info/server_info)
                if (responseData.user_info && responseData.user_info.status) {
                    const status = responseData.user_info.status.toLowerCase();
                    if (status === 'active' || status === 'enabled') {
                        // Credenciais V√ÅLIDAS mas servidor n√£o tem categorias live
                        log(`‚úÖ Credenciais V√ÅLIDAS (${responseData.user_info.username})`);
                        log('‚ö†Ô∏è Nenhuma categoria de canais ao vivo encontrada');
                        log('üí° Este servidor pode ter apenas VOD/Series');
                        hide('loading');
                        return;
                    } else {
                        // Credenciais inv√°lidas ou expiradas
                        console.error('‚ùå Credenciais inv√°lidas:', status);
                        log(`‚ùå Credenciais inv√°lidas (${status}). Verifique servidor/usu√°rio/senha.`);
                        hide('loading');
                        return;
                    }
                }

                // Resposta desconhecida
                console.error('‚ùå Resposta desconhecida:', responseData);
                log('‚ùå Resposta do servidor inv√°lida. Tente novamente.');
                hide('loading');

            } catch (e) {
                console.error('‚ùå Erro ao carregar categorias:', e);
                log(`‚ùå Erro: ${e.message}`);
            } finally {
                hide('loading');
            }
        }

        function renderCategories() {
            const grid = document.getElementById('categories-grid');
            grid.innerHTML = categories.map(cat =>
                `<button class="category-btn" onclick="loadChannels('${cat.category_id}')">${cat.category_name}</button>`
            ).join('');
        }

        async function loadChannels(catId) {
            console.log('üì¶ loadChannels chamado com catId:', catId, 'tipo:', typeof catId);
            console.log('üì¶ categories dispon√≠veis:', categories.map(c => ({id: c.category_id, name: c.category_name})));

            // Converter para n√∫mero para garantir compara√ß√£o correta
            const catIdNum = parseInt(catId, 10);
            const cat = categories.find(c => parseInt(c.category_id, 10) === catIdNum);
            if (!cat) {
                console.error('‚ùå Categoria n√£o encontrada:', catId);
                console.error('üì¶ IDs dispon√≠veis:', categories.map(c => c.category_id));
                log(`‚ùå Erro: Categoria ID ${catId} n√£o encontrada`);
                return;
            }

            log(`üì∫ Carregando canais: ${cat.category_name}`);
            console.log('üì¶ Category ID:', catId);
            show('loading');
            hide('channels-section');
            hide('selected-channel');

            try {
                const cleanHost = host.split(':')[0];
                const port = host.split(':')[1] || '80';
                const baseUrl = `http://${cleanHost}:${port}`;

                // Usar get_live_streams para canais ao vivo (XTream API)
                const url = `${baseUrl}/player_api.php?username=${username}&password=${password}&action=get_live_streams&category_id=${catId}`;

                console.log('üì¶ API URL:', url);
                log(`üì° Buscando canais via XTream API...`);
                const response = await fetch(`/api/iptv/proxy-new?url=${encodeURIComponent(url)}`);
                const responseData = await response.json();

                console.log('üìä Resposta canais:', responseData);

                // Verificar se √© array de canais (resposta normal)
                if (!Array.isArray(responseData)) {
                    console.error('‚ùå Resposta inv√°lida (esperava array):', responseData);
                    log('‚ùå Resposta do servidor inv√°lida');
                    hide('loading');
                    return;
                }

                allChannels = responseData;
                console.log('üì¶ Total canais:', allChannels.length);

                // Limit channels
                allChannels = allChannels.slice(0, 200);
                filteredChannels = [...allChannels];

                if (allChannels.length === 0) {
                    log('‚ö†Ô∏è Nenhum canal nesta categoria');
                    hide('loading');
                    return;
                }

                log(`‚úÖ ${allChannels.length} canais`);
                document.getElementById('channel-count').textContent = allChannels.length;

                console.log('üì¶ Renderizando canais...');
                renderChannels();
                console.log('üì¶ Mostrando channels-section...');

                show('channels-section');

            } catch (e) {
                console.error('‚ùå Erro ao carregar canais:', e);
                log(`‚ùå Erro: ${e.message}`);
            } finally {
                console.log('üì¶ Escondendo loading...');
                hide('loading');
            }
        }

        function renderChannels() {
            const list = document.getElementById('channel-list');
            const favorites = getFavorites();
            list.innerHTML = filteredChannels.map(ch =>
                `<div class="channel-item ${selectedChannel?.stream_id === ch.stream_id ? 'selected' : ''}"
                     onclick="selectChannel(${ch.stream_id})">
                    <div class="channel-item-fav">
                        <span style="flex: 1;">${ch.name}</span>
                        <button class="favorite-btn ${favorites.includes(ch.stream_id) ? 'is-favorite' : ''}"
                                onclick="event.stopPropagation(); toggleFavorite(${ch.stream_id})"
                                title="${favorites.includes(ch.stream_id) ? 'Remover dos favoritos' : 'Adicionar aos favoritos'}">
                            ${favorites.includes(ch.stream_id) ? '‚≠ê' : '‚òÜ'}
                        </button>
                    </div>
                </div>`
            ).join('');
        }

        function filterChannels() {
            const query = document.getElementById('search-input').value.toLowerCase();
            filteredChannels = allChannels.filter(ch => ch.name.toLowerCase().includes(query));
            renderChannels();
        }

        function selectChannel(streamId) {
            selectedChannel = allChannels.find(ch => ch.stream_id === streamId);
            if (!selectedChannel) return;

            // Montar URL do stream usando formato XTream
            // http://host:port/username/password/stream_id.m3u8
            const cleanHost = host.split(':')[0];
            const port = host.split(':')[1] || '80';
            const streamUrl = `http://${cleanHost}:${port}/${username}/${password}/${streamId}.m3u8`;

            // Adicionar URL ao objeto selecionado
            selectedChannel.url = streamUrl;

            log(`üéØ Selecionado: ${selectedChannel.name}`);
            document.getElementById('channel-name').textContent = selectedChannel.name;
            document.getElementById('stream-url').textContent = streamUrl;
            show('selected-channel');
            renderChannels();
        }

        // Universal player - auto-detects best method
        function openUniversal() {
            if (!selectedChannel) {
                log('‚ùå Selecione um canal');
                return;
            }

            const url = selectedChannel.url;
            const ua = navigator.userAgent.toLowerCase();
            const isAndroid = ua.includes('android');
            const isIOS = /iphone|ipad|ipod/.test(ua);

            log(`üöÄ Universal: ${selectedChannel.name}`);

            if (isAndroid) {
                // Try VLC first on Android
                try {
                    window.location.href = `vlc://${url}`;
                    log('‚úÖ VLC Android');
                    return;
                } catch (e) {}
            }

            if (isIOS) {
                // Try VLC on iOS
                try {
                    window.location.href = `vlc-x-callback://x-callback-url/stream?url=${encodeURIComponent(url)}`;
                    log('‚úÖ VLC iOS');
                    return;
                } catch (e) {}
            }

            // Try Web Video Caster
            try {
                window.location.href = `wvc-x-callback://open?url=${encodeURIComponent(url)}`;
                log('‚úÖ WVC');
                return;
            } catch (e) {}

            // Fallback: copy URL
            copyUrl();
        }

        function openInVLC() {
            if (!selectedChannel) {
                log('‚ùå Selecione um canal');
                return;
            }

            const url = selectedChannel.url;
            log(`üçä VLC: ${selectedChannel.name}`);

            try {
                window.location.href = `vlc://${url}`;
                log('‚úÖ VLC');
            } catch (e) {
                log('‚ùå VLC falhou');
            }
        }

        function openInJustPlayer() {
            if (!selectedChannel) {
                log('‚ùå Selecione um canal');
                return;
            }

            const url = selectedChannel.url;
            log(`üì± JustPlayer: ${selectedChannel.name}`);

            try {
                // JustPlayer intent
                const intent = `intent://x-callback-url/stream?url=${encodeURIComponent(url)}#Intent;scheme=justplayer;package=com.taktsoft.justplayer;end`;
                window.location.href = intent;
                log('‚úÖ JustPlayer');
            } catch (e) {
                log('‚ùå JustPlayer n√£o instalado');
            }
        }

        function copyUrl() {
            if (!selectedChannel) {
                log('‚ùå Selecione um canal');
                return;
            }

            const url = selectedChannel.url;
            navigator.clipboard.writeText(url).then(() => {
                log('‚úÖ URL copiada');
            }).catch(() => {
                log('‚ùå Erro ao copiar');
            });
        }

        // ==================== FAVORITOS ====================
        function getFavorites() {
            const saved = localStorage.getItem('iptv_favorites');
            return saved ? JSON.parse(saved) : [];
        }

        function toggleFavorite(streamId) {
            const favorites = getFavorites();
            const index = favorites.indexOf(streamId);

            if (index >= 0) {
                // Remover dos favoritos
                favorites.splice(index, 1);
                log('üìå Removido dos favoritos');
            } else {
                // Adicionar aos favoritos
                favorites.push(streamId);
                log('‚≠ê Adicionado aos favoritos');
            }

            localStorage.setItem('iptv_favorites', JSON.stringify(favorites));
            renderChannels();
            renderFavorites();
        }

        function showTab(tab) {
            const catsSection = document.getElementById('categories-section');
            const favsSection = document.getElementById('favorites-section');
            const chansSection = document.getElementById('channels-section');

            // Esconder todas as se√ß√µes
            hide('categories-section');
            hide('favorites-section');
            hide('channels-section');
            hide('selected-channel');

            // Atualizar bot√µes das tabs
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tab}-fav`)?.classList.add('active');
            document.getElementById(`tab-${tab}`)?.classList.add('active');

            if (tab === 'categories') {
                show('categories-section');
            } else if (tab === 'favorites') {
                show('favorites-section');
                renderFavorites();
            }
        }

        function renderFavorites() {
            const list = document.getElementById('favorites-list');
            const favorites = getFavorites();
            const allFavorites = allChannels.filter(ch => favorites.includes(ch.stream_id));

            if (allFavorites.length === 0) {
                hide('favorites-list');
                show('no-favorites');
                return;
            }

            hide('no-favorites');
            show('favorites-list');

            list.innerHTML = allFavorites.map(ch =>
                `<div class="channel-item"
                     onclick="selectChannel(${ch.stream_id})">
                    <div class="channel-item-fav">
                        <span style="flex: 1;">${ch.name}</span>
                        <button class="favorite-btn is-favorite"
                                onclick="event.stopPropagation(); toggleFavorite(${ch.stream_id})"
                                title="Remover dos favoritos">
                            ‚≠ê
                        </button>
                    </div>
                </div>`
            ).join('');
        }

        function filterFavorites() {
            const query = document.getElementById('search-favorites').value.toLowerCase();
            const favorites = getFavorites();
            const allFavorites = allChannels.filter(ch =>
                favorites.includes(ch.stream_id) && ch.name.toLowerCase().includes(query)
            );

            const list = document.getElementById('favorites-list');

            if (allFavorites.length === 0) {
                hide('favorites-list');
                show('no-favorites');
                return;
            }

            hide('no-favorites');
            show('favorites-list');

            list.innerHTML = allFavorites.map(ch =>
                `<div class="channel-item"
                     onclick="selectChannel(${ch.stream_id})">
                    <div class="channel-item-fav">
                        <span style="flex: 1;">${ch.name}</span>
                        <button class="favorite-btn is-favorite"
                                onclick="event.stopPropagation(); toggleFavorite(${ch.stream_id})"
                                title="Remover dos favoritos">
                            ‚≠ê
                        </button>
                    </div>
                </div>`
            ).join('');
        }

        // ==================== VALIDA√á√ÉO AUTOM√ÅTICA ====================
        let currentCredentialsIndex = 0;
        let credentialsList = [];

        function loadAllCredentials() {
            const saved = localStorage.getItem('iptv_all_credentials');
            if (saved) {
                credentialsList = JSON.parse(saved);
                console.log(`üíæ ${credentialsList.length} credenciais salvas carregadas`);
            }
        }

        async function tryAllCredentials() {
            if (credentialsList.length === 0) {
                console.log('‚ùå Nenhuma credencial salva para tentar');
                return false;
            }

            for (let i = 0; i < credentialsList.length; i++) {
                const credentials = credentialsList[i];
                currentCredentialsIndex = i;

                console.log(`üîÑ Tentando credencial ${i + 1}/${credentialsList.length}...`);
                log(`üîÑ Tentando servidor: ${credentials.host}`);

                const success = await testConnection(credentials);

                if (success) {
                    console.log(`‚úÖ Credencial ${i + 1} funcionou!`);
                    log(`‚úÖ Conectado com sucesso!`);
                    return true;
                }
            }

            // Se chegou aqui, nenhuma funcionou
            console.log('‚ùå Todas as credenciais falharam');
            log('‚ùå Todas as credenciais salvas falharam. Por favor, insira novas credenciais.');

            // Limpar credenciais salvas e pedir novas
            localStorage.removeItem('iptv_all_credentials');
            localStorage.removeItem('iptv_saved_credentials');
            credentialsList = [];
            currentCredentialsIndex = 0;

            alert('Todas as credenciais salvas expiraram. Por favor, insira novas credenciais.');
            return false;
        }

        async function testConnection(credentials) {
            const cleanHost = credentials.host.split(':')[0];
            const port = credentials.host.split(':')[1] || '80';
            const baseUrl = `http://${cleanHost}:${port}`;

            try {
                const catUrl = `${baseUrl}/player_api.php?username=${credentials.username}&password=${credentials.password}&action=get_categories`;
                const response = await fetch(`/api/iptv/proxy-new?url=${encodeURIComponent(catUrl)}`);

                if (!response.ok) {
                    return false;
                }

                const data = await response.json();

                // Garantir que data √© um array
                if (!Array.isArray(data)) {
                    console.error('‚ùå Resposta inv√°lida:', data);
                    return false;
                }

                // Se recebeu um array v√°lido, a conex√£o funcionou
                if (data.length > 0) {
                    // Atualizar vari√°veis globais
                    host = credentials.host;
                    username = credentials.username;
                    password = credentials.password;

                    // Carregar categorias
                    categories = data.filter(cat => {
                        const name = cat.category_name.toLowerCase();
                        return BRAZIL_KEYWORDS.some(kw => name.includes(kw)) &&
                               !EXCLUDED_CATS.some(ex => name.includes(ex));
                    });

                    categories = categories.slice(0, 50);

                    return true;
                }

                return false;
            } catch (e) {
                console.error(`Erro ao testar conex√£o:`, e);
                return false;
            }
        }

        // Inicializar
        window.addEventListener('load', () => {
            console.log('üöÄ Player universal iniciado');
            loadCredentialsFromURL();
            loadAllCredentials();
        });
    </script>
</body>
</html>
