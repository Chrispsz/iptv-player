<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPTV Player</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #fff;
            min-height: 100vh;
        }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .header {
            background: linear-gradient(135deg, #7c3aed 0%, #2563eb 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .header-title { font-size: 24px; font-weight: 700; }
        .card {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        textarea {
            width: 100%;
            min-height: 120px;
            padding: 16px;
            border: 2px solid #334155;
            border-radius: 10px;
            background: #0f172a;
            color: #fff;
            font-size: 14px;
            font-family: monospace;
        }
        textarea:focus { outline: none; border-color: #60a5fa; }
        .button {
            background: #3b82f6;
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 16px 24px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            margin-top: 12px;
        }
        .button:hover { background: #2563eb; }
        .button:disabled { opacity: 0.5; cursor: not-allowed; }
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
        }
        .category-btn {
            background: rgba(255,255,255,0.1);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 14px;
            font-size: 14px;
            cursor: pointer;
        }
        .category-btn:hover { background: #3b82f6; }
        .channel-list {
            max-height: 400px;
            overflow-y: auto;
            background: #1e293b;
            border-radius: 12px;
            padding: 12px;
        }
        .channel-item {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #0f172a;
            border: 1px solid rgba(255,255,255,0.2);
            cursor: pointer;
            font-size: 14px;
        }
        .channel-item:hover, .channel-item.selected {
            background: #3b82f6;
            border-color: #3b82f6;
        }
        .selected-channel {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
            margin-top: 16px;
            border: 2px solid #3b82f6;
        }
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }
        .player-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 16px;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        .player-btn:hover { background: rgba(255,255,255,0.2); }
        .player-btn.universal {
            background: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
        }
        .player-btn.universal:hover { background: rgba(34, 197, 94, 0.3); }
        .hidden { display: none !important; }
        .loading { text-align: center; padding: 20px; color: #3b82f6; }
        .spinner {
            border: 4px solid rgba(255,255,255,0.2);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .log-box {
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            padding: 12px;
            margin-top: 16px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 11px;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: #1e293b;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .modal-title { font-size: 20px; font-weight: 700; }
        .modal-close {
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 18px;
            color: white;
        }
        .qr-container {
            text-align: center;
            padding: 16px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            margin-bottom: 16px;
        }
        .qr-code {
            background: white;
            padding: 12px;
            border-radius: 10px;
            display: inline-block;
        }
        .qr-instructions {
            text-align: center;
            font-size: 13px;
            line-height: 1.5;
            color: rgba(255,255,255,0.7);
        }
        .qr-instructions h3 {
            color: #f59e0b;
            font-size: 16px;
            margin-bottom: 12px;
        }
        .qr-btn {
            background: #22c55e;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 8px;
        }
        .qr-btn:hover { background: #16a34a; }
        .qr-btn.secondary {
            background: rgba(255,255,255,0.1);
            margin-top: 12px;
        }
        .qr-btn.secondary:hover { background: rgba(255,255,255,0.2); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-title">üì∫ IPTV Player</div>
        </div>

        <div class="card">
            <div style="margin-bottom: 12px; font-weight: 600;">Credenciais:</div>
            <textarea id="credentials-input" placeholder="Cole suas credenciais...

Exemplo:
Servidor: servidor.com:80
Usu√°rio: usuario
Senha: senha"></textarea>
            <button class="button" id="connect-btn" onclick="connect()">üîó Conectar</button>
        </div>

        <div id="categories-section" class="card hidden">
            <div style="margin-bottom: 12px; font-weight: 600;">Categorias:</div>
            <div id="categories-grid" class="categories-grid"></div>
        </div>

        <div id="channels-section" class="card hidden">
            <div style="margin-bottom: 12px; font-weight: 600;">
                Canais: <span id="channel-count">0</span>
            </div>
            <input type="text" id="search-input" placeholder="Buscar canal..."
                   style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #334155;
                          background: #0f172a; color: #fff; margin-bottom: 12px;"
                   oninput="filterChannels()">
            <div id="channel-list" class="channel-list"></div>
        </div>

        <div id="selected-channel" class="selected-channel hidden">
            <div style="font-size: 20px; font-weight: 700; margin-bottom: 12px;" id="channel-name">Canal Selecionado</div>
            <div style="font-size: 12px; word-break: break-all; background: #0f172a; padding: 10px;
                 border-radius: 8px; margin-bottom: 12px; color: #60a5fa;" id="stream-url"></div>

            <div style="font-weight: 600; margin-bottom: 12px;">Abrir no Player:</div>
            <div class="players-grid">
                <button class="player-btn universal" onclick="openUniversal()">
                    üöÄ Universal<br><small style="font-weight:400; opacity:0.7">Auto-detecta</small>
                </button>
                <button class="player-btn" onclick="openInVLC()">
                    üçä VLC<br><small style="font-weight:400; opacity:0.7">Android/iOS/Desktop</small>
                </button>
                <button class="player-btn" onclick="openInJustPlayer()">
                    üì± JustPlayer<br><small style="font-weight:400; opacity:0.7">Android TV</small>
                </button>
                <button class="player-btn" onclick="copyUrl()">
                    üìã Copiar URL<br><small style="font-weight:400; opacity:0.7">Cole no player</small>
                </button>
            </div>
        </div>

        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <div>Carregando...</div>
        </div>

        <div class="card">
            <button class="button" style="background: rgba(255,255,255,0.1);" onclick="generateQRCode()">
                üì∫ QR Code para TV
            </button>
        </div>

        <div class="log-box">
            <div style="margin-bottom: 8px; color: #60a5fa; font-weight: 700;">Log</div>
            <div id="log-output">Pronto.</div>
        </div>
    </div>

    <!-- Modal QR Code -->
    <div id="qr-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üì∫ QR Code para TV</div>
                <button class="modal-close" onclick="closeQRModal()">‚úï</button>
            </div>

            <div class="qr-container">
                <div id="qr-code" class="qr-code"></div>
            </div>

            <div class="qr-instructions">
                <h3>Op√ß√µes para TV Android:</h3>
                <p>Escaneie o QR Code ou clique abaixo:</p>

                <button class="qr-btn" onclick="openM3UURL()">
                    üì∫ Abrir M3U no JustPlayer
                </button>
                <button class="qr-btn secondary" onclick="openVLCIntent()">
                    üçä Abrir no VLC TV
                </button>
                <button class="qr-btn secondary" onclick="copyM3UUrl()">
                    üìã Copiar URL M3U
                </button>

                <p style="margin-top: 16px; font-size: 11px; opacity: 0.6;">
                    Escaneie ou use um app de leitor QR na TV
                </p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script>
        let host = '', username = '', password = '';
        let categories = [], allChannels = [], filteredChannels = [];
        let selectedChannel = null;
        let m3uUrl = '';

        const EXCLUDED_CATS = ['filme', 'movie', 'film', 'vod', 'series', 'series4k', '4kseries',
                               'radio', 'r√°dio', 'music', 'musica', 'audio', 'som', 'adult', 'xxx', 'porn'];
        const BRAZIL_KEYWORDS = ['brasil', 'brazil', 'brasileira', 'brasileiro', 'globo', 'record',
                               'sbt', 'band', 'rede', 'aberta', 'aberto', 's√£o paulo', 'rio', 'minas',
                               'bahia', 'paran√°', 'catarinense', 'ga√∫cha', 'bras√≠lia', 'df', 'sp',
                               'rj', 'mg', 'rs', 'pr', 'sc', 'ba', 'pe', 'go', 'es', 'ce', 'am', 'pa', 'rn'];

        function log(msg) {
            const logBox = document.getElementById('log-output');
            const time = new Date().toLocaleTimeString();
            logBox.innerHTML += `<div class="log-entry">[${time}] ${msg}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
        }

        function show(id) { document.getElementById(id).classList.remove('hidden'); }
        function hide(id) { document.getElementById(id).classList.add('hidden'); }

        async function connect() {
            const text = document.getElementById('credentials-input').value;

            // Parse credentials
            const lines = text.split('\n');
            lines.forEach(line => {
                const lower = line.toLowerCase().trim();
                if (lower.includes('servidor:') || lower.includes('*servidor:')) {
                    const match = line.match(/[:*]\s*([^:\s]+)/);
                    if (match) host = match[1].trim();
                }
                if (lower.includes('usu√°rio:') || lower.includes('usuario:') || lower.includes('*usu√°rio:') || lower.includes('*usuario:')) {
                    const match = line.match(/[:*]\s*([^\s]+)/);
                    if (match) username = match[1].trim();
                }
                if (lower.includes('senha:') || lower.includes('*senha:')) {
                    const match = line.match(/[:*]\s*([^\s]+)/);
                    if (match) password = match[1].trim();
                }
                if (lower.includes('m3u+:')) {
                    const urlMatch = line.match(/https?:\/\/([^\/]+)/);
                    if (urlMatch) host = urlMatch[1].trim();
                }
                if (lower.includes('get.php')) {
                    const urlMatch = line.match(/username=([^&]+)/);
                    if (urlMatch) username = urlMatch[1].trim();
                    const passMatch = line.match(/password=([^&]+)/);
                    if (passMatch) password = passMatch[1].trim();
                }
            });

            if (!host || !username || !password) {
                log('‚ùå Credenciais inv√°lidas');
                return;
            }

            log('üîó Conectando...');
            hide('categories-section');
            hide('channels-section');
            hide('selected-channel');

            // Fix port
            if (!host.includes(':')) {
                host += ':80';
            }

            const cleanHost = host.split(':')[0];
            const port = host.split(':')[1] || '80';
            const baseUrl = `http://${cleanHost}:${port}`;

            // Load categories
            show('loading');
            try {
                const catUrl = `${baseUrl}/player_api.php?username=${username}&password=${password}&action=get_categories`;
                log(`üìÇ Carregando categorias...`);
                const response = await fetch(`https://corsproxy.io/?` + encodeURIComponent(catUrl));
                categories = await response.json();

                // Filter Brazilian
                categories = categories.filter(cat => {
                    const name = cat.category_name.toLowerCase();
                    return BRAZIL_KEYWORDS.some(kw => name.includes(kw)) &&
                           !EXCLUDED_CATS.some(ex => name.includes(ex));
                });

                // Also include important categories
                categories = categories.filter(cat => {
                    const name = cat.category_name.toLowerCase();
                    return BRAZIL_KEYWORDS.some(kw => name.includes(kw)) &&
                           !EXCLUDED_CATS.some(ex => name.includes(ex));
                });

                // Limit to top categories
                categories = categories.slice(0, 50);

                log(`‚úÖ ${categories.length} categorias`);
                renderCategories();
                show('categories-section');

                // Save M3U URL for QR
                m3uUrl = `${baseUrl}/get.php?username=${username}&password=${password}&type=m3u_plus`;
                log(`üì∫ M3U: ${m3uUrl.substring(0, 50)}...`);

            } catch (e) {
                log(`‚ùå Erro: ${e.message}`);
            } finally {
                hide('loading');
            }
        }

        function renderCategories() {
            const grid = document.getElementById('categories-grid');
            grid.innerHTML = categories.map(cat =>
                `<button class="category-btn" onclick="loadChannels(${cat.category_id})">${cat.category_name}</button>`
            ).join('');
        }

        async function loadChannels(catId) {
            const cat = categories.find(c => c.category_id === catId);
            if (!cat) return;

            log(`üì∫ Carregando canais: ${cat.category_name}`);
            show('loading');
            hide('channels-section');
            hide('selected-channel');

            try {
                const cleanHost = host.split(':')[0];
                const port = host.split(':')[1] || '80';
                const baseUrl = `http://${cleanHost}:${port}`;
                const url = `${baseUrl}/player_api.php?username=${username}&password=${password}&action=get_streams&category_id=${catId}`;

                const response = await fetch(`https://corsproxy.io/?` + encodeURIComponent(url));
                allChannels = await response.json();

                // Limit channels
                allChannels = allChannels.slice(0, 200);
                filteredChannels = [...allChannels];

                log(`‚úÖ ${allChannels.length} canais`);
                document.getElementById('channel-count').textContent = allChannels.length;
                renderChannels();
                show('channels-section');

            } catch (e) {
                log(`‚ùå Erro: ${e.message}`);
            } finally {
                hide('loading');
            }
        }

        function renderChannels() {
            const list = document.getElementById('channel-list');
            list.innerHTML = filteredChannels.map(ch =>
                `<div class="channel-item ${selectedChannel?.stream_id === ch.stream_id ? 'selected' : ''}"
                     onclick="selectChannel(${ch.stream_id})">${ch.name}</div>`
            ).join('');
        }

        function filterChannels() {
            const query = document.getElementById('search-input').value.toLowerCase();
            filteredChannels = allChannels.filter(ch => ch.name.toLowerCase().includes(query));
            renderChannels();
        }

        function selectChannel(streamId) {
            selectedChannel = allChannels.find(ch => ch.stream_id === streamId);
            if (!selectedChannel) return;

            log(`üéØ Selecionado: ${selectedChannel.name}`);
            document.getElementById('channel-name').textContent = selectedChannel.name;
            document.getElementById('stream-url').textContent = selectedChannel.url;
            show('selected-channel');
            renderChannels();
        }

        // Universal player - auto-detects best method
        function openUniversal() {
            if (!selectedChannel) {
                log('‚ùå Selecione um canal');
                return;
            }

            const url = selectedChannel.url;
            const ua = navigator.userAgent.toLowerCase();
            const isAndroid = ua.includes('android');
            const isIOS = /iphone|ipad|ipod/.test(ua);

            log(`üöÄ Universal: ${selectedChannel.name}`);

            if (isAndroid) {
                // Try VLC first on Android
                try {
                    window.location.href = `vlc://${url}`;
                    log('‚úÖ VLC Android');
                    return;
                } catch (e) {}
            }

            if (isIOS) {
                // Try VLC on iOS
                try {
                    window.location.href = `vlc-x-callback://x-callback-url/stream?url=${encodeURIComponent(url)}`;
                    log('‚úÖ VLC iOS');
                    return;
                } catch (e) {}
            }

            // Try Web Video Caster
            try {
                window.location.href = `wvc-x-callback://open?url=${encodeURIComponent(url)}`;
                log('‚úÖ WVC');
                return;
            } catch (e) {}

            // Fallback: copy URL
            copyUrl();
        }

        function openInVLC() {
            if (!selectedChannel) {
                log('‚ùå Selecione um canal');
                return;
            }

            const url = selectedChannel.url;
            log(`üçä VLC: ${selectedChannel.name}`);

            try {
                window.location.href = `vlc://${url}`;
                log('‚úÖ VLC');
            } catch (e) {
                log('‚ùå VLC falhou');
            }
        }

        function openInJustPlayer() {
            if (!selectedChannel) {
                log('‚ùå Selecione um canal');
                return;
            }

            const url = selectedChannel.url;
            log(`üì± JustPlayer: ${selectedChannel.name}`);

            try {
                // JustPlayer intent
                const intent = `intent://x-callback-url/stream?url=${encodeURIComponent(url)}#Intent;scheme=justplayer;package=com.taktsoft.justplayer;end`;
                window.location.href = intent;
                log('‚úÖ JustPlayer');
            } catch (e) {
                log('‚ùå JustPlayer n√£o instalado');
            }
        }

        function copyUrl() {
            if (!selectedChannel) {
                log('‚ùå Selecione um canal');
                return;
            }

            const url = selectedChannel.url;
            navigator.clipboard.writeText(url).then(() => {
                log('‚úÖ URL copiada');
            }).catch(() => {
                log('‚ùå Erro ao copiar');
            });
        }

        // QR Code for TV
        function generateQRCode() {
            if (!m3uUrl) {
                log('‚ùå Conecte primeiro');
                return;
            }

            log('üì∫ Gerando QR Code...');

            try {
                const container = document.getElementById('qr-code');
                container.innerHTML = '';

                QRCode.toCanvas(container, m3uUrl, {
                    width: 200,
                    errorCorrectionLevel: 'H'
                });

                document.getElementById('qr-modal').classList.add('active');
                log('‚úÖ QR Code gerado');

            } catch (e) {
                log(`‚ùå Erro: ${e.message}`);
            }
        }

        function closeQRModal() {
            document.getElementById('qr-modal').classList.remove('active');
        }

        // Open M3U in JustPlayer from QR modal
        function openM3UURL() {
            log('üì∫ Abrindo M3U no JustPlayer...');
            try {
                const intent = `intent://x-callback-url/load?url=${encodeURIComponent(m3uUrl)}#Intent;scheme=justplayer;package=com.taktsoft.justplayer;end`;
                window.location.href = intent;
                log('‚úÖ JustPlayer');
            } catch (e) {
                log('‚ùå JustPlayer n√£o instalado');
            }
        }

        // Open VLC intent
        function openVLCIntent() {
            log('üçä Abrindo M3U no VLC TV...');
            try {
                const intent = `intent://x-callback-url/stream?url=${encodeURIComponent(m3uUrl)}#Intent;scheme=vlc;package=org.videolan.vlc;end`;
                window.location.href = intent;
                log('‚úÖ VLC');
            } catch (e) {
                log('‚ùå VLC n√£o instalado');
            }
        }

        // Copy M3U URL
        function copyM3UUrl() {
            navigator.clipboard.writeText(m3uUrl).then(() => {
                log('‚úÖ URL M3U copiada');
            }).catch(() => {
                log('‚ùå Erro ao copiar');
            });
        }
    </script>
</body>
</html>
